#!/bin/sh -e 

CURRENT_PATH="`dirname \"$0\"`"
CURRENT_PATH="`( cd \"$CURRENT_PATH\" && pwd )`"

COORDINATOR="$CURRENT_PATH/objclint-coordinator"

"$COORDINATOR" -start &>/dev/null&
sleep 1
"$COORDINATOR" -check

set +e

TEMP_FILE=`mktemp -t "xcodebuild-"`

d

export OBJCLINT=YES
xcodebuild -PBXBuildsContinueAfterErrors=YES "$@" &> "$TEMP_FILE"

XCODE_RESULT=$?

# ommiting '-job 1' here may cause multiple analyzis of header files
# but lack of it significantly increases build time

if [ $XCODE_RESULT != 0 ]; then
    echo "Got errors while running xcodebuild. See '$TEMP_FILE' for details" >&2
fi

set -e

"$COORDINATOR" -report
exit $XCODE_RESULT||$?
